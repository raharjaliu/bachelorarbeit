% Chapter Template

\chapter{PubSeq Tagging Pipeline} % Main chapter title

\label{Chapter4} % Change X to a consecutive number; for referencing this chapter elsewhere, use \ref{ChapterX}

\lhead{Chapter 4. \emph{PubSeq tagging Pipeline}} % Change X to a consecutive number; this is for the header on each page - perhaps a shortened title

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------

\section{Introduction}

In this chapter, we would discuss various steps belonging to Tagging Pipeline. Following main steps belong to the Tagging Pipeline:

\begin{enumerate}
\item \textbf{Formatting} downloaded MEDLINE abstract into input files that are compliant with Lars' NER Tagger. \label{itm:TaggingStep1} (1)
\item \textbf{Named Entity tagging} done by Lars NER Tagger. \label{itm:TaggingStep2} (2)
\item \textbf{Post-processing} of the results and \textbf{preparation} for the entry into Solr index. \label{itm:TaggingStep3} (3)
\item \textbf{Updating} of results onto Solr Index. \label{itm:TaggingStep4} (4)
\end{enumerate}

The processes are then further divided into several single programs:

\begin{itemize}
\item \texttt{XMLAbstractsFormatter.java}
\item \texttt{tagcorpus.cxx}
\item \texttt{AnnotationBackmapper.java}
\item \texttt{Annotater.java}
\item \texttt{StatisticsUtils.java}
\item \texttt{IndexerNew.java}
\item \texttt{SolrUpdater.java}
\end{itemize}

The division of the whole pipeline into smaller tasks are reasoned through following arguments:
\begin{itemize}
\item The NER Tagger \ref{itm:TaggingStep2} was developed in C++ while we would implement the rest of pipeline (\ref{itm:TaggingStep1}, \ref{itm:TaggingStep3} and \ref{itm:TaggingStep4}) in Java. This means that pre- and post-tagging procedures would have to be implemented separately. Also since the NER Tagger wasn't written by us and therefore support would be very lacking, we would rather leave the NER Tagger as it is.
\item Related to previous argument: Solr is implemented in Java and its most comprehensive API (written by the developers of the Solr themselves) is written in Java \citep{grainger2014solr}. Therefore using Java in \ref{itm:TaggingStep4} would be almost necessary for various convenience reasons.
\item The pipeline generally is very memory intensive. During the process, several maps that each would gulp easily teens of gigabyte of memory are utilized. Therefore each step that utilizes such huge maps are all separated into one single routine.
\item Dividing the pipeline into smaller components would make it easy to debug, since each routine easily takes several minutes if not hours to run. However this also makes expanding features within the Tagging Pipeline more difficult.
\end{itemize}

Besides processes mentioned above, there is one process that doesn't exactly belong to Tagging Pipeline but is closely coupled and synchronized with it: downloading and storing of MEDLINE abstracts. Both download and maintenance of MEDLINE corpus and the Tagging pipeline would be covered in following sub-chapters.

%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{MEDLINE Abstracts}

\label{sec:MEDLINEAbstracts}

We used NLM's leasing scheme \citep{MEDLINE} to retrieve the MEDLINE corpus. Each day, an updated from MEDLINE server is downloaded via FTP protocol onto our server. The update will happen daily at around 8 A.M. server time (CET/CEST). Each update is formatted as an XML file, each with an incrementing numerical identifier: the files are named \texttt{meldine15nXXXX.xml} with \texttt{XXXX} the integer identifier -- that is, the update file \texttt{meldine15n1057.xml} comes right after \texttt{meldine15n1056.xml} and before \texttt{meldine15n1058.xml}. The definition of MEDLINE XML file currently follows National Library of Medicine's (NLM) MEDLINE/PubMed Document Type Definition (DTD) \citep{MEDLINEDTD}, which at the time of thesis writing, is currently at the version dated 01/01/2015 \footnote{accessed 8/20/2015}.


Following is a slightly redacted example of a MEDLINE reference, which is taken for the paper by Karapakis-Liaskos and Ferrero, Nat. Rev. Immunol., 2015\footnote{doi:10.1038/nri3837}:

\label{lst:MEDLINEDTD}
\begin{verbatim}
<MedlineCitation Owner="NLM" Status="In-Data-Review">
<PMID Version="1">25976515</PMID>
<DateCreated>
<Year>2015</Year>
<Month>05</Month>
<Day>26</Day>
</DateCreated>
<Article PubModel="Print-Electronic">
<Journal>
<ISSN IssnType="Electronic">1474-1741</ISSN>
<JournalIssue CitedMedium="Internet">
<Volume>15</Volume>
<Issue>6</Issue>
<PubDate>
<Year>2015</Year>
<Month>Jun</Month>
</PubDate>
</JournalIssue>
<Title>Nature reviews. Immunology</Title>
<ISOAbbreviation>Nat. Rev. Immunol.</ISOAbbreviation>
</Journal>
<ArticleTitle>Immune modulation ... membrane vesicles.</ArticleTitle>
<Pagination>
<MedlinePgn>375-87</MedlinePgn>
</Pagination>
<ELocationID EIdType="doi" ValidYN="Y">10.1038/nri3837</ELocationID>
<Abstract>
<AbstractText>Gram-negative ... nanotechnologies.</AbstractText>
</Abstract>
<AuthorList CompleteYN="Y">
<Author ValidYN="Y">
<LastName>Kaparakis-Liaskos</LastName>
<ForeName>Maria</ForeName>
<Initials>M</Initials>
<AffiliationInfo>
<Affiliation>MIMR-PHI Institute of ..., Australia.</Affiliation>
</AffiliationInfo>
</Author>
<Author ValidYN="Y">
<LastName>Ferrero</LastName>
<ForeName>Richard L</ForeName>
<Initials>RL</Initials>
<AffiliationInfo>
<Affiliation>MIMR-PHI Institute of ..., Australia.</Affiliation>
</AffiliationInfo>
</Author>
</AuthorList>
<Language>eng</Language>
<PublicationTypeList>
<PublicationType UI="D016428">Journal Article</PublicationType>
</PublicationTypeList>
<ArticleDate DateType="Electronic">
<Year>2015</Year>
<Month>05</Month>
<Day>15</Day>
</ArticleDate>
</Article>
<MedlineJournalInfo>
<Country>England</Country>
<MedlineTA>Nat Rev Immunol</MedlineTA>
<NlmUniqueID>101124169</NlmUniqueID>
<ISSNLinking>1474-1733</ISSNLinking>
</MedlineJournalInfo>
<CitationSubset>IM</CitationSubset>
</MedlineCitation>
\end{verbatim}

%----------------------------------------------------------------------------------------
%	SUBSECTION 2.1
%----------------------------------------------------------------------------------------

\subsection{Specifications}

\begin{table}[htbp]
\caption{Specifications table for PubSeq MEDLINE Abstracts}
\centering
\begin{tabular}{ | l | l | }
  \hline
  Parameter & Value \\
  \hline
  URL, repo & none \\
  Path, clone & none \\
  Path, running program & \texttt{/mnt/project/rost\_db/medline}\\
  \hline
\end{tabular}
\end{table}

%\begin{figure}[!h]
%	\theverbbox
%\caption{An example of a reference from XML MEDLINE corpus}
%\label{fig:singlecell_chemo}
%\end{figure}

%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{XMLAbstractFormatter.java}

This class represents a formatter that parses the MEDLINE abstract files and transforms it into Lars' tagger compliant format. It follows NLM DTD for MEDLINE \citep{MEDLINEDTD} as parsing reference. In the directory where the updates were downloaded, it lists down all possible XML files and parses files that had not been processed before. For each XML file, it creates a tree representation of the file through full. Owning to its tree-like structure \citep{bray2011extensible} \citep{MEDLINEDTD}, this implies that each \texttt{MedlineCitation} tag is itself is a tree (see Section \ref{lst:MEDLINEDTD}) . For each \texttt{MedlineCitation} it extracts needed information such as PubMed ID, title, journal name, publication date, abstract, authors and associated MeSH IDs \citep{lowe1994understanding} and writes it out.

\subsection{Parameters}

\begin{lstlisting}[breaklines]
path_to_medline ner_output_path mesh_output_path counter_file counter_max
\end{lstlisting}

\begin{itemize}
\item \texttt{path\_to\_medline} refers to the location of MEDLINE xml abstracts. The program will recursively traverse all sub directories of this path and parse files matching following name pattern: \texttt{meldine15nXXXX.xml}.

\texttt{ner\_output\_path} refers to path the first output file (with name) should be written onto. The first output file would then be used for Tagging by PubSeq NER Tagger.

\texttt{mesh\_output\_path }refers to path the second output file (with name) should be written onto. The second output file contains associative table between PMID and list of MeSH IDs associated with the publication. Since Lars' program input is fixed we write this information in separate file.

\item \texttt{counter\_file} refers to file containing the location of last parsing. The program parses \texttt{XXXX} of the name format and figures whether current integer is larger than the one written in \texttt{counter\_file} before parsing the content of the update file. Upon the completion of the run, the program will replace the value within \texttt{counter\_file} with the largest \texttt{XXX} it encountered. This would be then the starting point of the next run.

\item \texttt{counter\_max} is the path of file containing the maximum \texttt{XXXX} this program should read. If \texttt{counter\_file} contains 1000 and \texttt{counter\_max} 1500 it will only parse \texttt{meldine15n1001.xml} all the way through \texttt{meldine15n1500.xml} in this run. Note that \texttt{counter\_max} is not updated after run. If \texttt{counter\_max} doesn't exist in system then the it assumes \texttt{Integer.MAX\_VALUE} \footnote{\href{http://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html}{http://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html}, accessed 08/20/2015} as upper bound of the parsing.
\end{itemize}

\subsection{Specifications}

\begin{table}[htbp]
\caption{Specifications table for XMLAbstractsFormatter.java}
\centering
\begin{tabularx}{\textwidth}{ | l | X | }
  \hline
  Parameter & Value \\
  \hline
  URL, repo & \href{https://rostlab.informatik.tu-muenchen.de/gitlab/gyachdav/pubseq-crawler/blob/master/PubSeq/src/org/pubseq/utils/XMLAbstractsFormatter.java}{https://rostlab.informatik.tu-muenchen.de/gitlab/gyachdav/pubseq-crawler/blob/master/PubSeq/src/org/pubseq/utils/} \href{https://rostlab.informatik.tu-muenchen.de/gitlab/gyachdav/pubseq-crawler/blob/master/PubSeq/src/org/pubseq/utils/XMLAbstractsFormatter.java}{XMLAbstractsFormatter.java} \\
  Path, clone & \texttt{/mnt/project/pubseq/pandu/pubseq-crawler/PubSeq} \texttt{/src/org/pubseq/utils/XMLAbstractsFormatter.java} \\
  Path, running program & \texttt{/mnt/project/pubseq/dev/pubseq-tagging} \texttt{/PubSeqUtils/src/org/pubseq/utils} \texttt{/XMLAbstractsFormatter.class}\\
  \hline
\end{tabularx}
\end{table}

%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{tagcorpus.cxx}


